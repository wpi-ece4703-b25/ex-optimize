#include <stdio.h>
#include <errno.h>
#include <unistd.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>

// fs=48Khz, fpass=11800Hz, fstop=12200Hz, Apass=0.1db, Astop=70db
#define TAPS 365

float hbcoef[TAPS] = {
  -0.0004273585664985,-0.0002634415908448,0.0006161155580915, 0.001467635526193,
   0.001216655063127,0.0001820800277591,-0.0002812725104506,0.0001584512591413,
   0.000429313151396,-8.471522511036e-06,-0.0003196491368419,4.339506866066e-05,
  0.0003278735114319,-2.974322560356e-05,-0.0003195131461105,3.377817826412e-05,
  0.0003282804359096,-3.21805259775e-05,-0.0003393196990297,3.162772108911e-05,
  0.0003551432024167,-2.976540473433e-05,-0.0003735273841429,2.708372716868e-05,
  0.0003943458739126,-2.324132531635e-05,-0.0004170323326099,1.858042828065e-05,
   0.000441432586257,-1.296592917515e-05,-0.0004673116928043,6.523928926268e-06,
  0.0004947951717537,1.069747308164e-06,-0.000523449808956,-9.315951451214e-06,
  0.0005538294862491,1.882450933004e-05,-0.0005852418936884,-2.905051807916e-05,
  0.0006181074820608,4.036927016291e-05,-0.0006523617030799,-5.278859456653e-05,
  0.0006879393934288,6.622924793939e-05,-0.0007249081494017,-8.07675115968e-05,
  0.0007632843995818,9.651403387453e-05,-0.0008029489768952,-0.0001133133642494,
  0.0008441866044425,0.0001314956266274,-0.0008867728997725,-0.0001508324553222,
    0.00093096838629,0.0001715694483807,-0.0009766834522709,-0.0001936917480361,
   0.001023924183817,0.0002171333169066,-0.001072899544352,-0.0002421776239042,
   0.001123500388537,0.0002688378876702,-0.001175754763379,-0.0002970110259469,
   0.001229971902693, 0.000327096125521,   -0.001285841486,-0.0003588343066526,
    0.00134363937692,0.0003923839443521,-0.001403525356915,-0.0004280837412785,
   0.001465246024637,0.0004656914403211,-0.001529129769223,-0.0005054162235109,
   0.001595304790133,0.0005475762218145,-0.001663560438274,-0.0005919140638117,
      0.001734344121,0.0006388001226203,-0.001807660218184,-0.0006884534173349,
   0.001883375948157,0.0007407053050058,-0.001961884237247,-0.000795884885558,
   0.002043262787683,0.0008542256463412,-0.002127515217784,-0.0009157240747729,
   0.002214958855692,0.0009806691963439,-0.002305756081739,-0.001049308977414,
   0.002400005879778, 0.001121735801362,-0.002497997152916,-0.001198153210943,
   0.002600143195929, 0.001279044859862,-0.002706637066965,-0.001364839567863,
   0.002817489478648, 0.001455565869877,-0.002933219244561,-0.001551610239542,
   0.003054266371073, 0.001653404759236,-0.003181136581453,-0.001761471364395,
   0.003314524016512, 0.001876897572205,-0.003454312993808,-0.002000045152577,
   0.003600505727503, 0.002130295035593,-0.003755046664019,-0.002268788490136,
   0.003919500439749, 0.002417823747167,-0.004093641858358,-0.002578294696648,
   0.004277582010998, 0.002749976698493,-0.004473633348728,-0.002934636277996,
    0.00468345107717,  0.00313458261099,-0.004907644809271,-0.003350624077043,
   0.005148745704379, 0.003584826473313,-0.005409816008008,-0.003841001459449,
   0.005692106899113, 0.004120823151986,-0.005999764343597,-0.004428018606737,
   0.006337535442137, 0.004768328859188,-0.006708957642995,-0.005146163966701,
   0.007120648430383, 0.005568204678402,-0.007581087485768,-0.006044417883295,
   0.008098412044491, 0.006584261267005,-0.008686549035373,-0.007203001574093,
   0.009361800727987, 0.007920082378713,   -0.010145629446,-0.008760485401786,
    0.01106942083341, 0.009760910539674, -0.01217597224444, -0.01097338115449,
    0.01352696051771,  0.01247304530549, -0.01521948664505, -0.01438151879335,
    0.01740198946746,  0.01689111963741, -0.02033387533273, -0.02034856508259,
    0.02448534260317,  0.02541971061568, -0.03083464027135, -0.03359552892509,
    0.04177837231268,  0.04901413030549, -0.06519361029681, -0.08905708069214,
     0.1509681844733,   0.4492130196235,   0.4492130196235,   0.1509681844733,
   -0.08905708069214, -0.06519361029681,  0.04901413030549,  0.04177837231268,
   -0.03359552892509, -0.03083464027135,  0.02541971061568,  0.02448534260317,
   -0.02034856508259, -0.02033387533273,  0.01689111963741,  0.01740198946746,
   -0.01438151879335, -0.01521948664505,  0.01247304530549,  0.01352696051771,
   -0.01097338115449, -0.01217597224444, 0.009760910539674,  0.01106942083341,
  -0.008760485401786,   -0.010145629446, 0.007920082378713, 0.009361800727987,
  -0.007203001574093,-0.008686549035373, 0.006584261267005, 0.008098412044491,
  -0.006044417883295,-0.007581087485768, 0.005568204678402, 0.007120648430383,
  -0.005146163966701,-0.006708957642995, 0.004768328859188, 0.006337535442137,
  -0.004428018606737,-0.005999764343597, 0.004120823151986, 0.005692106899113,
  -0.003841001459449,-0.005409816008008, 0.003584826473313, 0.005148745704379,
  -0.003350624077043,-0.004907644809271,  0.00313458261099,  0.00468345107717,
  -0.002934636277996,-0.004473633348728, 0.002749976698493, 0.004277582010998,
  -0.002578294696648,-0.004093641858358, 0.002417823747167, 0.003919500439749,
  -0.002268788490136,-0.003755046664019, 0.002130295035593, 0.003600505727503,
  -0.002000045152577,-0.003454312993808, 0.001876897572205, 0.003314524016512,
  -0.001761471364395,-0.003181136581453, 0.001653404759236, 0.003054266371073,
  -0.001551610239542,-0.002933219244561, 0.001455565869877, 0.002817489478648,
  -0.001364839567863,-0.002706637066965, 0.001279044859862, 0.002600143195929,
  -0.001198153210943,-0.002497997152916, 0.001121735801362, 0.002400005879778,
  -0.001049308977414,-0.002305756081739,0.0009806691963439, 0.002214958855692,
  -0.0009157240747729,-0.002127515217784,0.0008542256463412, 0.002043262787683,
  -0.000795884885558,-0.001961884237247,0.0007407053050058, 0.001883375948157,
  -0.0006884534173349,-0.001807660218184,0.0006388001226203,    0.001734344121,
  -0.0005919140638117,-0.001663560438274,0.0005475762218145, 0.001595304790133,
  -0.0005054162235109,-0.001529129769223,0.0004656914403211, 0.001465246024637,
  -0.0004280837412785,-0.001403525356915,0.0003923839443521,  0.00134363937692,
  -0.0003588343066526,   -0.001285841486, 0.000327096125521, 0.001229971902693,
  -0.0002970110259469,-0.001175754763379,0.0002688378876702, 0.001123500388537,
  -0.0002421776239042,-0.001072899544352,0.0002171333169066, 0.001023924183817,
  -0.0001936917480361,-0.0009766834522709,0.0001715694483807,  0.00093096838629,
  -0.0001508324553222,-0.0008867728997725,0.0001314956266274,0.0008441866044425,
  -0.0001133133642494,-0.0008029489768952,9.651403387453e-05,0.0007632843995818,
  -8.07675115968e-05,-0.0007249081494017,6.622924793939e-05,0.0006879393934288,
  -5.278859456653e-05,-0.0006523617030799,4.036927016291e-05,0.0006181074820608,
  -2.905051807916e-05,-0.0005852418936884,1.882450933004e-05,0.0005538294862491,
  -9.315951451214e-06,-0.000523449808956,1.069747308164e-06,0.0004947951717537,
  6.523928926268e-06,-0.0004673116928043,-1.296592917515e-05, 0.000441432586257,
  1.858042828065e-05,-0.0004170323326099,-2.324132531635e-05,0.0003943458739126,
  2.708372716868e-05,-0.0003735273841429,-2.976540473433e-05,0.0003551432024167,
  3.162772108911e-05,-0.0003393196990297,-3.21805259775e-05,0.0003282804359096,
  3.377817826412e-05,-0.0003195131461105,-2.974322560356e-05,0.0003278735114319,
  4.339506866066e-05,-0.0003196491368419,-8.471522511036e-06, 0.000429313151396,
  0.0001584512591413,-0.0002812725104506,0.0001820800277591, 0.001216655063127,
   0.001467635526193,0.0006161155580915,-0.0002634415908448,-0.0004273585664985
};

float left_taps[TAPS];
float right_taps[TAPS];

void filter_init() {
  int i;
  for (i=0; i<TAPS; i++) {
    left_taps[i] = 0;
    right_taps[i] = 0;
  }
}

float filter_sample(float *taps, float insample) {
  int i;
  float q = 0;
  taps[0] = insample;
  for (i=0; i<TAPS; i++)
    q += taps[i] * hbcoef[i];
  for (i=TAPS-1; i>0; i--)
    taps[i] = taps[i-1];
  return q;
}

void filter_block(float *taps, float *insamples, int n, float *outsamples) {
  int i;
  for (i=0; i<n; i++)
    outsamples[i] = filter_sample(taps, insamples[i]);
}
     
#include <jack/jack.h>

static inline unsigned long long ccnt_read(void) {
    struct timespec ts;
    clock_gettime(CLOCK_MONOTONIC, &ts);
    return (unsigned long long)ts.tv_sec * 1000000000ULL + ts.tv_nsec;
}

jack_port_t *input_port_left;
jack_port_t *output_port_left;
jack_port_t *input_port_right;
jack_port_t *output_port_right;
jack_client_t *client;

int process (jack_nframes_t nframes, void *arg) {
  jack_default_audio_sample_t *inleft, *outleft;
  jack_default_audio_sample_t *inright, *outright;

  inleft = jack_port_get_buffer (input_port_left, nframes);
  outleft = jack_port_get_buffer (output_port_left, nframes);
  inright = jack_port_get_buffer (input_port_right, nframes);
  outright = jack_port_get_buffer (output_port_right, nframes);

  long long ticks0 = ccnt_read();  
  filter_block(left_taps,  inleft,  nframes, outleft);
  filter_block(right_taps, inright, nframes, outright);
  long long ticks1 = ccnt_read() - ticks0;  
  static int blocks = 0;
  if (((++blocks) % 128) == 0)
    printf("Ticks %lld\n", ticks1);
  
  return 0;
}

void jack_shutdown (void *arg) {
        exit (1);
}

int main (int argc, char *argv[]) {
  const char **ports;
  const char *client_name = "simple";
  const char *server_name = NULL;
  jack_options_t options = JackNullOption;
  jack_status_t status;

  client = jack_client_open (client_name, options, &status, server_name);
  if (client == NULL) {
    fprintf (stderr, "jack_client_open() failed, status = 0x%2.0x\n", status);
    if (status & JackServerFailed) {
      fprintf (stderr, "Unable to connect to JACK server\n");
    }
    exit (1);
  }
  if (status & JackServerStarted) {
    fprintf (stderr, "JACK server started\n");
  }
  if (status & JackNameNotUnique) {
    client_name = jack_get_client_name(client);
    fprintf (stderr, "unique name `%s' assigned\n", client_name);
  }

  filter_init();
  
  jack_set_process_callback (client, process, 0);
  jack_on_shutdown (client, jack_shutdown, 0);

  printf ("engine sample rate: %" PRIu32 "\n", jack_get_sample_rate (client));

  input_port_left = jack_port_register (client, "input_left",
                                   JACK_DEFAULT_AUDIO_TYPE,
                                   JackPortIsInput, 0);
  output_port_left = jack_port_register (client, "output_left",
                                    JACK_DEFAULT_AUDIO_TYPE,
                                    JackPortIsOutput, 0);
  input_port_right = jack_port_register (client, "input_right",
                                   JACK_DEFAULT_AUDIO_TYPE,
                                   JackPortIsInput, 0);
  output_port_right = jack_port_register (client, "output_right",
                                    JACK_DEFAULT_AUDIO_TYPE,
                                    JackPortIsOutput, 0);

  if ((input_port_left == NULL) || (output_port_left == NULL) ||
      (input_port_right == NULL) || (output_port_right == NULL)) {
    fprintf(stderr, "no more JACK ports available\n");
    exit (1);
  }

  if (jack_activate (client)) {
    fprintf (stderr, "cannot activate client");
    exit (1);
  }

  while (1)
    sleep(10);

  jack_client_close (client);
  
  exit (0);
}
